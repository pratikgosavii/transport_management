{% extends 'expense/base_main.html' %}


{% block title %}Add Other Expenses (Bulk){% endblock title %}

{% block breadcrumbs %}
{% endblock breadcrumbs %}

{% block head %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script> 

<style>
    .select2-container {
        min-width: 200px !important;
    }
    
    .selection {
        height: 50px;
        display: grid;
    }

    .select2-results__option {
        padding-right: 20px;
        vertical-align: middle;
    }
    
    .select2-results__option:before {
        content: "";
        display: inline-block;
        position: relative;
        height: 20px;
        width: 20px;
        border: 2px solid #e9e9e9;
        border-radius: 4px;
        background-color: #fff;
        margin-right: 20px;
        vertical-align: middle;
    }
    
    .select2-results__option[aria-selected=true]:before {
        font-family: fontAwesome;
        content: "\f00c";
        color: #fff;
        background-color: #f77750;
        border: 0;
        display: inline-block;
        padding-left: 3px;
    }
    
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #fff;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #eaeaeb;
        color: #272727;
    }
    
    .select2-container--default .select2-selection--multiple {
        margin-bottom: 10px;
    }
    
    .select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple {
        border-radius: 4px;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #f77750;
        border-width: 2px;
    }
    
    .select2-container--default .select2-selection--multiple {
        border-width: 2px;
    }
    
    .select2-container--open .select2-dropdown--below {
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        width: max-content !important;
    }
    
    .select-icon .select2-selection__placeholder .badge {
        display: none;
    }
    
    .select-icon .placeholder {
        display: none;
    }
    
    .select-icon .select2-results__option:before,
    .select-icon .select2-results__option[aria-selected=true]:before {
        display: none !important;
    }
    
    .select-icon .select2-search--dropdown {
        display: none;
    }

    .select2-container .select2-selection--single {
        height: 38px;
    }

    /* Table styling improvements */
    .expense-table {
        margin-bottom: 20px;
    }
    
    .expense-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-align: center;
        padding: 12px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .expense-table tbody td {
        padding: 12px;
        vertical-align: middle;
    }
    
    .expense-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .expense-table tbody tr:nth-child(even) {
        background-color: #ffffff;
    }
    
    .expense-table tbody tr:nth-child(odd) {
        background-color: #f8f9fa;
    }
    
    .expense-table tbody tr:hover {
        background-color: #e9ecef;
    }
    
    .row-number {
        text-align: center;
        font-weight: 600;
        color: #495057;
        width: 50px;
    }
    
    .form-control {
        border-radius: 4px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        border-color: #f77750;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(247, 119, 80, 0.25);
    }
    
    .submit-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }
    
    .card-header {
        background-color: #fff;
        border-bottom: 2px solid #dee2e6;
        padding: 20px;
    }
    
    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #495057;
        margin: 0;
    }
    
    .card-body {
        padding: 25px;
    }
    
    @media (max-width: 768px) {
        .expense-table {
            font-size: 14px;
        }
        
        .expense-table thead th,
        .expense-table tbody td {
            padding: 8px;
        }
    }
</style>

{% endblock head %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <strong class="card-title">Add Other Expenses (Bulk Entry)</strong>
            </div>
            <div class="card-body">
                <form id="other_expense_json_form" method="post">
                    {% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-bordered expense-table">
                            <thead>
                                <tr>
                                    <th class="row-number">#</th>
                                    <th>Expense Category</th>
                                    <th>Amount</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in '0123456789'|make_list %}
                                <tr>
                                    <td class="row-number">{{ forloop.counter }}</td>
                                    <td>
                                        <select name="expense_category" id="id_expense_category{{ i }}" class="form-control expense-category-select">
                                            <option value="">Select Category</option>
                                            {% for obj in form.expense_category.field.queryset %}
                                                <option value="{{ obj.id }}">{{ obj.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" 
                                               name="amount{{ i }}" 
                                               class="form-control amount" 
                                               step="0.01" 
                                               min="0" 
                                               placeholder="0.00">
                                    </td>
                                    <td>
                                        <input type="text" 
                                               name="note{{ i }}" 
                                               class="form-control note" 
                                               placeholder="Enter note (optional)">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="submit-section">
                        <button id="payment-button" type="submit" class="btn btn-lg btn-info btn-block">
                            <span id="payment-button-amount">Submit Expenses</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}

<script>
    $(document).ready(function() {
        // Initialize Select2 for all expense category fields
        $('.expense-category-select').select2({
            placeholder: 'Select Expense Category',
            allowClear: true,
            width: '100%'
        });
        
        // Remove 'required' attribute from all input and select fields initially
        $('table').find('input, select').removeAttr('required');

        // Make the first row's fields required
        $('table tbody tr:first-child').find('input, select').attr('required', 'required');

        // Function to make all fields in a row required if any field is filled
        $('table').on('input change', 'input, select', function() {
            var $row = $(this).closest('tr');
            var anyFilled = $row.find('input, select').filter(function() {
                var val = $(this).val();
                return val !== null && val !== undefined && val.toString().trim() !== "";
            }).length > 0;

            if (anyFilled) {
                $row.find('input, select').attr('required', 'required');
            } else {
                $row.find('input, select').removeAttr('required');
            }
        });

        // Handle form submission with AJAX
        $('#other_expense_json_form').on('submit', function(evt) {
            evt.preventDefault();
            
            var submitButton = $('#payment-button');
            if (submitButton.prop('disabled')) {
                return false;
            }
            
            submitButton.prop('disabled', true);
            $('#payment-button-amount').text('Submitting...');

            var formData = $(this).serialize();

            $.ajax({
                type: 'POST',
                url: "{% url 'add_other_expense_json' %}",
                data: formData,
                success: function(response) {
                    console.log(response);
                    
                    try {
                        var data = JSON.parse(response);
                        
                        if (data.status == "done") {
                            window.location.reload();
                        } else {
                            alert('Error: ' + (data.message || 'Wrong contact pratik'));
                            submitButton.prop('disabled', false);
                            $('#payment-button-amount').text('Submit Expenses');
                        }
                    } catch (e) {
                        console.error('Error parsing response:', e);
                        alert('Error processing response. Please try again.');
                        submitButton.prop('disabled', false);
                        $('#payment-button-amount').text('Submit Expenses');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    alert('Error submitting form. Please try again.');
                    submitButton.prop('disabled', false);
                    $('#payment-button-amount').text('Submit Expenses');
                }
            });
        });
    });
</script>

{% endblock js %}
