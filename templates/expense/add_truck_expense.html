{% extends 'expense/base_main.html' %}


{% block title %}Submit{% endblock title %}

{% block breadcrumbs %}
{% endblock breadcrumbs %}

{% block head %}


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>    <!-- imp -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script> 


<style>

    




    
    .select2-container {
        min-width: 200px !important;
     }
     

     

     .selection{
       height: 50px;
   display: grid;
     }


     .select2-results__option {
       padding-right: 20px;
       vertical-align: middle;
     }
     .select2-results__option:before {
       content: "";
       display: inline-block;
       position: relative;
       height: 20px;
       width: 20px;
       border: 2px solid #e9e9e9;
       border-radius: 4px;
       background-color: #fff;
       margin-right: 20px;
       vertical-align: middle;
     }
     .select2-results__option[aria-selected=true]:before {
       font-family:fontAwesome;
       content: "\f00c";
       color: #fff;
       background-color: #f77750;
       border: 0;
       display: inline-block;
       padding-left: 3px;
     }
     .select2-container--default .select2-results__option[aria-selected=true] {
       background-color: #fff;
     }
     .select2-container--default .select2-results__option--highlighted[aria-selected] {
       background-color: #eaeaeb;
       color: #272727;
     }
     .select2-container--default .select2-selection--multiple {
       margin-bottom: 10px;
     }
     .select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple {
       border-radius: 4px;
     }
     .select2-container--default.select2-container--focus .select2-selection--multiple {
       border-color: #f77750;
       border-width: 2px;
     }
     .select2-container--default .select2-selection--multiple {
       border-width: 2px;
     }
     .select2-container--open .select2-dropdown--below {
       
       border-radius: 6px;
       box-shadow: 0 0 10px rgba(0,0,0,0.5);
       width: max-content !important;
     }
     .select2-selection .select2-selection--multiple:after {
       content: 'hhghgh';
     }
     /* select with icons badges single*/
     .select-icon .select2-selection__placeholder .badge {
       display: none;
     }
     .select-icon .placeholder {
       display: none;
     }
     .select-icon .select2-results__option:before,
     .select-icon .select2-results__option[aria-selected=true]:before {
       display: none !important;
       /* content: "" !important; */
     }
     .select-icon  .select2-search--dropdown {
       display: none;
     }



     .select2-container .select2-selection--single {
       height: 38px;
     }

     .logged-in {
       color: orange;
       font-size: 21px;
     }

     /* Hide expense type specific fields by default */
     .tyre-expense-fields,
     .mechanic-expense-fields {
       display: none;
     }

     .col-mechanic-wrap {
       display: flex;
       align-items: center;
       gap: 6px;
     }
     .col-mechanic-wrap .col-mechanic {
       flex: 1;
       min-width: 0;
     }
     .col-mechanic-wrap .col-mechanic .select2-container { min-width: 120px !important; }
     .col-mechanic-wrap .add-mechanic-btn { flex-shrink: 0; }

     /* Excel-like horizontal form */
     .expense-toolbar {
       display: flex;
       flex-wrap: wrap;
       align-items: center;
       gap: 12px;
       margin-bottom: 12px;
       padding: 10px 0;
       border-bottom: 1px solid #dee2e6;
     }
     .expense-toolbar .truck-wrap { display: flex; align-items: center; gap: 8px; }
     .expense-toolbar .truck-wrap label { margin: 0; white-space: nowrap; }
     .expense-toolbar .truck-wrap .select2-container { min-width: 180px !important; }
     #add-expense-row {
       padding: 8px 20px;
       font-weight: 600;
       border-radius: 6px;
     }
     .expense-sheet-wrap {
       overflow-x: auto;
       margin-bottom: 16px;
       border: 1px solid #c6c8ca;
       border-radius: 4px;
       background: #fff;
     }
     #expense-rows-table {
       margin: 0;
       table-layout: auto;
       border-collapse: collapse;
     }
     #expense-rows-table thead th {
       background: #05386b;
       color: #fff;
       font-weight: 600;
       font-size: 12px;
       padding: 10px 8px;
       border: 1px solid #03294a;
       white-space: nowrap;
       position: sticky;
       top: 0;
       z-index: 2;
     }
     #expense-rows-table tbody td {
       padding: 4px 6px;
       border: 1px solid #dee2e6;
       vertical-align: middle;
     }
     #expense-rows-table tbody tr.expense-row:nth-child(even) { background: #f8f9fa; }
     #expense-rows-table tbody tr.expense-row:hover { background: #e9ecef; }
     #expense-rows-table .form-control {
       height: 34px;
       padding: 4px 8px;
       font-size: 13px;
       border-radius: 4px;
     }
     #expense-rows-table .select2-container .select2-selection--single { height: 34px !important; }
     #expense-rows-table .select2-container .select2-selection__rendered { line-height: 32px !important; }
     #expense-rows-table .select2-container .select2-selection__arrow { height: 32px !important; }
     #expense-rows-table .form-control:focus { border-color: #05386b; box-shadow: 0 0 0 2px rgba(5,56,107,0.2); }
     #expense-rows-table th.col-row-no { width: 40px; text-align: center; }
     #expense-rows-table td.col-row-no { text-align: center; font-weight: 600; color: #6c757d; }
     #expense-rows-table .remove-row { padding: 4px 10px; font-size: 12px; }
     .expense-footer {
       display: flex;
       flex-wrap: wrap;
       align-items: center;
       justify-content: space-between;
       gap: 16px;
       padding: 12px 0;
       border-top: 2px solid #05386b;
     }
     .expense-footer .grand-total-wrap { display: flex; align-items: center; gap: 10px; }
     .expense-footer #grand_total { font-weight: 700; font-size: 1.1rem; }

</style>


{% endblock head %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <strong class="card-title">Add Truck Expense</strong>
            </div>
            <div class="card-body">
                <!-- Credit Card -->
                <div id="pay-invoice">
                    <div class="card-body">
                      <form id="expense_form" action="#" method="post" >
                            {% csrf_token %}
                            <div class="expense-toolbar">
                                <div class="truck-wrap">
                                    <label class="control-label mb-0">Truck <span style="color: red;">*</span></label>
                                    {{ form.truck }}
                                </div>
                                <button type="button" id="add-expense-row" class="btn btn-primary" style="background-color:#05386b; border:none;">+ Add Row</button>
                                <small class="text-muted mb-0">Add multiple expenses at once â€” one row = one expense. Scroll horizontally to see all columns.</small>
                            </div>

                            <div class="expense-sheet-wrap">
                                <table class="table table-bordered" id="expense-rows-table">
                                    <thead>
                                        <tr>
                                            <th class="col-row-no">#</th>
                                            <th style="min-width:100px;">Type</th>
                                            <th style="min-width:90px;">Tyre No</th>
                                            <th style="min-width:90px;">Pattern</th>
                                            <th style="min-width:90px;">Tyre Type</th>
                                            <th style="min-width:100px;">Company</th>
                                            <th style="min-width:120px;">Driver</th>
                                            <th style="min-width:130px;">Mechanic</th>
                                            <th style="min-width:100px;">Spare Part</th>
                                            <th style="min-width:80px;">Labour</th>
                                            <th style="min-width:80px;">Cost</th>
                                            <th style="min-width:140px;">Work</th>
                                            <th style="min-width:120px;">Vendor</th>
                                            <th style="min-width:90px;">Amount *</th>
                                            <th style="min-width:140px;">Note</th>
                                            <th style="min-width:110px;">Entry Date</th>
                                            <th style="min-width:50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="expense-rows-body">
                                        <!-- rows inserted by JS -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="expense-footer">
                                <div class="grand-total-wrap">
                                    <strong>Total:</strong>
                                    <input type="text" id="grand_total" class="form-control" style="width:140px;" readonly value="0.00">
                                </div>
                                <button id="payment-button" type="submit" class="btn btn-lg btn-info" style="background-color:#05386b; border:none;">
                                    <span id="payment-button-amount">Submit all expenses</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div> <!-- .card -->

    </div><!--/.col-->
</div>

<!-- Modal: Add new mechanic -->
<div class="modal fade" id="addMechanicModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Mechanic</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-mechanic-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="new_mechanic_name">Name <span style="color:red;">*</span></label>
                        <input type="text" id="new_mechanic_name" class="form-control" name="name" required placeholder="Mechanic name">
                    </div>
                    <div class="form-group">
                        <label for="new_mechanic_mobile">Mobile (optional)</label>
                        <input type="text" id="new_mechanic_mobile" class="form-control" name="mobile_number" placeholder="Mobile number">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-mechanic-submit">Add Mechanic</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

    {% block js %}

        <script>
            
            $('.sele').select2();

            function buildRowHtml() {
                // Use the same choice sets as the Django form fields
                const expenseTypeOptions = `{{ form.expense_type|safe }}`; // not used directly
                // We'll reconstruct selects from the form field HTML by cloning in DOM (below).
                return `
                    <tr class="expense-row">
                        <td class="col-row-no"></td>
                        <td class="col-expense-type"></td>
                        <td><input name="tyre_no[]" class="form-control tyre_no" placeholder="Tyre no"></td>
                        <td class="col-pattern"></td>
                        <td class="col-tyre-type"></td>
                        <td><input name="company[]" class="form-control company" placeholder="Company"></td>
                        <td class="col-driver"></td>
                        <td class="col-mechanic-wrap"><span class="col-mechanic"></span><button type="button" class="btn btn-sm btn-outline-secondary add-mechanic-btn" title="Add new mechanic">+ Add</button></td>
                        <td><input name="spare_part_name[]" class="form-control spare_part_name" placeholder="Spare part"></td>
                        <td><input name="labour_cost[]" class="form-control labour_cost" type="number" step="0.01" min="0" placeholder="0.00"></td>
                        <td><input name="cost[]" class="form-control cost" type="number" step="0.01" min="0" placeholder="0.00"></td>
                        <td><input name="work_description[]" class="form-control work_description" placeholder="Work desc"></td>
                        <td class="col-vendor"></td>
                        <td><input name="amount[]" class="form-control amount" type="number" step="0.01" min="0" placeholder="0.00" required></td>
                        <td><input name="note[]" class="form-control note" placeholder="Note"></td>
                        <td><input name="entry_date[]" class="form-control entry_date" type="date"></td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td>
                    </tr>
                `;
            }

            function makeSelectFromField(fieldHtml, nameAttr, extraClass) {
                // fieldHtml is like <select ...>...</select>
                const $tmp = $('<div>').html(fieldHtml);
                const $sel = $tmp.find('select').first();
                $sel.attr('name', nameAttr);
                $sel.addClass('form-control sele ' + (extraClass || ''));
                // Remove id to avoid duplicates
                $sel.removeAttr('id');
                return $sel;
            }

            const fieldHtml = {
                expense_type: `{{ form.expense_type|safe }}`,
                pattern: `{{ form.pattern|safe }}`,
                tyre_type: `{{ form.type|safe }}`,
                driver: `{{ form.driver|safe }}`,
                mechanic: `{{ form.mechanic|safe }}`,
                vendor: `{{ form.vendor|safe }}`,
            };

            function applyRowControls($row) {
                // Insert selects
                $row.find('.col-expense-type').append(makeSelectFromField(fieldHtml.expense_type, 'expense_type[]', 'expense_type'));
                $row.find('.col-pattern').append(makeSelectFromField(fieldHtml.pattern, 'pattern[]', 'pattern'));
                $row.find('.col-tyre-type').append(makeSelectFromField(fieldHtml.tyre_type, 'type[]', 'type'));
                $row.find('.col-driver').append(makeSelectFromField(fieldHtml.driver, 'driver[]', 'driver'));
                $row.find('.col-mechanic').append(makeSelectFromField(fieldHtml.mechanic, 'mechanic[]', 'mechanic'));
                $row.find('.col-vendor').append(makeSelectFromField(fieldHtml.vendor, 'vendor[]', 'vendor'));

                // Init select2 for selects inside this row
                $row.find('.sele').select2();

                // Default hide type-specific columns depending on expense type
                function toggleRow($r) {
                    const t = $r.find('select.expense_type').val();
                    const isTyre = (t === 'tyre');
                    const isMech = (t === 'mechanic');

                    // tyre inputs
                    $r.find('.tyre_no, .company').closest('td').toggle(isTyre);
                    $r.find('select.pattern, select.type, select.driver').closest('td').toggle(isTyre);

                    // mechanic inputs (mechanic dropdown + add btn, spare part, labour, cost, work)
                    $r.find('.col-mechanic-wrap').closest('td').toggle(isMech);
                    $r.find('.spare_part_name, .labour_cost, .cost, .work_description').closest('td').toggle(isMech);

                    // for other: hide both tyre and mechanic specifics
                    if (!isTyre && !isMech) {
                        $r.find('.tyre_no, .company').closest('td').hide();
                        $r.find('select.pattern, select.type, select.driver').closest('td').hide();
                        $r.find('.col-mechanic-wrap').closest('td').hide();
                        $r.find('.spare_part_name, .labour_cost, .cost, .work_description').closest('td').hide();
                    }
                }

                $row.on('change', 'select.expense_type', function () {
                    toggleRow($row);
                });

                // Mechanic auto-calc: labour + cost -> amount
                $row.on('input', '.labour_cost, .cost', function () {
                    const t = $row.find('select.expense_type').val();
                    if (t === 'mechanic') {
                        const labour = parseFloat($row.find('.labour_cost').val()) || 0;
                        const cost = parseFloat($row.find('.cost').val()) || 0;
                        const total = labour + cost;
                        $row.find('.amount').val(total.toFixed(2));
                        updateGrandTotal();
                    }
                });

                $row.on('input', '.amount', function () {
                    updateGrandTotal();
                });

                // Add mechanic button: open modal and remember row for selecting new mechanic after add
                $row.on('click', '.add-mechanic-btn', function () {
                    var $rowForMechanic = $(this).closest('tr');
                    $('#addMechanicModal').data('targetRow', $rowForMechanic).modal('show');
                });

                toggleRow($row);
            }

            // Add new mechanic via AJAX and refresh dropdowns
            function addMechanicAndRefresh(name, mobile_number, $targetRow) {
                var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                var payload = { name: name, mobile_number: mobile_number || '', csrfmiddlewaretoken: csrf };
                $.ajax({
                    url: "{% url 'add_mechanic_ajax' %}",
                    type: 'POST',
                    data: payload,
                    dataType: 'json',
                    success: function (data) {
                        var res = typeof data === 'string' ? JSON.parse(data) : data;
                        if (res.status === 'True' && res.id && res.value) {
                            $('#expense-rows-body select.mechanic').each(function () {
                                var $sel = $(this);
                                if ($sel.find('option[value="' + res.id + '"]').length === 0) {
                                    $sel.append(new Option(res.value, res.id, false, false));
                                }
                            });
                            if ($targetRow && $targetRow.length) {
                                var $mechSelect = $targetRow.find('select.mechanic');
                                if ($mechSelect.find('option[value="' + res.id + '"]').length === 0) {
                                    $mechSelect.append(new Option(res.value, res.id, true, true));
                                }
                                $mechSelect.val(res.id).trigger('change');
                            }
                            $('#addMechanicModal').modal('hide');
                            $('#new_mechanic_name, #new_mechanic_mobile').val('');
                        }
                    },
                    error: function (xhr) {
                        var err = 'Failed to add mechanic.';
                        try {
                            var j = typeof xhr.responseJSON !== 'undefined' ? xhr.responseJSON : JSON.parse(xhr.responseText);
                            if (j.error) err = typeof j.error === 'string' ? j.error : JSON.stringify(j.error);
                        } catch (e) {}
                        alert(err);
                    }
                });
            }

            $(document).ready(function() {
                $('#add-mechanic-submit').on('click', function () {
                    var name = $('#new_mechanic_name').val().trim();
                    if (!name) {
                        alert('Please enter mechanic name.');
                        return;
                    }
                    var mobile = $('#new_mechanic_mobile').val().trim();
                    var $targetRow = $('#addMechanicModal').data('targetRow');
                    addMechanicAndRefresh(name, mobile, $targetRow);
                });
            });

            function updateRowNumbers() {
                $('#expense-rows-body tr.expense-row').each(function (i) {
                    $(this).find('td.col-row-no').first().text(i + 1);
                });
            }

            function addRow() {
                const $row = $(buildRowHtml());
                $('#expense-rows-body').append($row);
                applyRowControls($row);
                updateRowNumbers();
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let total = 0;
                $('#expense-rows-body .amount').each(function () {
                    const v = parseFloat($(this).val());
                    if (!isNaN(v)) total += v;
                });
                $('#grand_total').val(total.toFixed(2));
            }

            $(document).ready(function() {
                // Start with 1 row
                addRow();

                $('#add-expense-row').on('click', function () {
                    addRow();
                });

                $('#expense-rows-body').on('click', '.remove-row', function () {
                    $(this).closest('tr').remove();
                    updateRowNumbers();
                    updateGrandTotal();
                });
            });

            // Prevent duplicate submissions
            $('#payment-button').on('click', function(e) {
                var submitButton = $(this);
                if (submitButton.prop('disabled')) {
                    e.preventDefault();
                    return false;
                }
                // Disable button after a small delay to allow form submission to proceed
                setTimeout(function() {
                    submitButton.prop('disabled', true);
                    $('#payment-button-amount').text('Submitting...');
                }, 10);
            });
        </script>

    {% endblock js %}
