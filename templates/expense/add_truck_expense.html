{% extends 'expense/base_main.html' %}


{% block title %}Submit{% endblock title %}

{% block breadcrumbs %}
{% endblock breadcrumbs %}

{% block head %}


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>    <!-- imp -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script> 


<style>

    




    
    .select2-container {
        min-width: 200px !important;
     }
     

     

     .selection{
       height: 50px;
   display: grid;
     }


     .select2-results__option {
       padding-right: 20px;
       vertical-align: middle;
     }
     .select2-results__option:before {
       content: "";
       display: inline-block;
       position: relative;
       height: 20px;
       width: 20px;
       border: 2px solid #e9e9e9;
       border-radius: 4px;
       background-color: #fff;
       margin-right: 20px;
       vertical-align: middle;
     }
     .select2-results__option[aria-selected=true]:before {
       font-family:fontAwesome;
       content: "\f00c";
       color: #fff;
       background-color: #f77750;
       border: 0;
       display: inline-block;
       padding-left: 3px;
     }
     .select2-container--default .select2-results__option[aria-selected=true] {
       background-color: #fff;
     }
     .select2-container--default .select2-results__option--highlighted[aria-selected] {
       background-color: #eaeaeb;
       color: #272727;
     }
     .select2-container--default .select2-selection--multiple {
       margin-bottom: 10px;
     }
     .select2-container--default.select2-container--open.select2-container--below .select2-selection--multiple {
       border-radius: 4px;
     }
     .select2-container--default.select2-container--focus .select2-selection--multiple {
       border-color: #f77750;
       border-width: 2px;
     }
     .select2-container--default .select2-selection--multiple {
       border-width: 2px;
     }
     .select2-container--open .select2-dropdown--below {
       
       border-radius: 6px;
       box-shadow: 0 0 10px rgba(0,0,0,0.5);
       width: max-content !important;
     }
     .select2-selection .select2-selection--multiple:after {
       content: 'hhghgh';
     }
     /* select with icons badges single*/
     .select-icon .select2-selection__placeholder .badge {
       display: none;
     }
     .select-icon .placeholder {
       display: none;
     }
     .select-icon .select2-results__option:before,
     .select-icon .select2-results__option[aria-selected=true]:before {
       display: none !important;
       /* content: "" !important; */
     }
     .select-icon  .select2-search--dropdown {
       display: none;
     }



     .select2-container .select2-selection--single {
       height: 38px;
     }

     .logged-in {
       color: orange;
       font-size: 21px;
     }

     /* Hide expense type specific fields by default */
     .tyre-expense-fields,
     .mechanic-expense-fields {
       display: none;
     }

</style>


{% endblock head %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <strong class="card-title">Add Truck Expense</strong>
            </div>
            <div class="card-body">
                <!-- Credit Card -->
                <div id="pay-invoice">
                    <div class="card-body">
                      <form id="expense_form" action="#" method="post" >
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="name" class="control-label mb-1">Truck <span style="color: red;">*</span></label>
                                {{ form.truck }}
                            </div>

                            <div style="display:flex; gap:10px; align-items:center; margin-bottom: 10px;">
                                <button type="button" id="add-expense-row" class="btn btn-sm btn-primary" style="background-color:#05386b; border:none;">+ Add Row</button>
                                <small class="text-muted">Truck will remain same; add multiple expense rows below.</small>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered" id="expense-rows-table">
                                    <thead>
                                        <tr>
                                            <th style="min-width:140px;">Type</th>
                                            <th style="min-width:140px;">Tyre No</th>
                                            <th style="min-width:140px;">Pattern</th>
                                            <th style="min-width:140px;">Tyre Type</th>
                                            <th style="min-width:140px;">Company</th>
                                            <th style="min-width:160px;">Driver</th>
                                            <th style="min-width:160px;">Mechanic</th>
                                            <th style="min-width:160px;">Spare Part</th>
                                            <th style="min-width:120px;">Labour</th>
                                            <th style="min-width:120px;">Cost</th>
                                            <th style="min-width:180px;">Work</th>
                                            <th style="min-width:160px;">Vendor</th>
                                            <th style="min-width:120px;">Amount *</th>
                                            <th style="min-width:180px;">Note</th>
                                            <th style="min-width:140px;">Entry Date</th>
                                            <th style="min-width:80px;">#</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expense-rows-body">
                                        <!-- rows inserted by JS -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="form-group" style="display:flex; justify-content:flex-end; gap:15px; align-items:center;">
                                <strong>Total:</strong>
                                <input type="text" id="grand_total" class="form-control" style="width:200px;" readonly value="0.00">
                            </div>

                            <div>
                                <button id="payment-button" type="submit" class="btn btn-lg btn-info btn-block">
                                    <span id="payment-button-amount">Submit</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div> <!-- .card -->

    </div><!--/.col-->
</div>

{% endblock content %}

    {% block js %}

        <script>
            
            $('.sele').select2();

            function buildRowHtml() {
                // Use the same choice sets as the Django form fields
                const expenseTypeOptions = `{{ form.expense_type|safe }}`; // not used directly
                // We'll reconstruct selects from the form field HTML by cloning in DOM (below).
                return `
                    <tr class="expense-row">
                        <td class="col-expense-type"></td>
                        <td><input name="tyre_no[]" class="form-control tyre_no" placeholder="Tyre no"></td>
                        <td class="col-pattern"></td>
                        <td class="col-tyre-type"></td>
                        <td><input name="company[]" class="form-control company" placeholder="Company"></td>
                        <td class="col-driver"></td>
                        <td><input name="mechanic_name[]" class="form-control mechanic_name" placeholder="Mechanic"></td>
                        <td><input name="spare_part_name[]" class="form-control spare_part_name" placeholder="Spare part"></td>
                        <td><input name="labour_cost[]" class="form-control labour_cost" type="number" step="0.01" min="0" placeholder="0.00"></td>
                        <td><input name="cost[]" class="form-control cost" type="number" step="0.01" min="0" placeholder="0.00"></td>
                        <td><input name="work_description[]" class="form-control work_description" placeholder="Work desc"></td>
                        <td class="col-vendor"></td>
                        <td><input name="amount[]" class="form-control amount" type="number" step="0.01" min="0" placeholder="0.00" required></td>
                        <td><input name="note[]" class="form-control note" placeholder="Note"></td>
                        <td><input name="entry_date[]" class="form-control entry_date" type="date"></td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td>
                    </tr>
                `;
            }

            function makeSelectFromField(fieldHtml, nameAttr, extraClass) {
                // fieldHtml is like <select ...>...</select>
                const $tmp = $('<div>').html(fieldHtml);
                const $sel = $tmp.find('select').first();
                $sel.attr('name', nameAttr);
                $sel.addClass('form-control sele ' + (extraClass || ''));
                // Remove id to avoid duplicates
                $sel.removeAttr('id');
                return $sel;
            }

            const fieldHtml = {
                expense_type: `{{ form.expense_type|safe }}`,
                pattern: `{{ form.pattern|safe }}`,
                tyre_type: `{{ form.type|safe }}`,
                driver: `{{ form.driver|safe }}`,
                vendor: `{{ form.vendor|safe }}`,
            };

            function applyRowControls($row) {
                // Insert selects
                $row.find('.col-expense-type').append(makeSelectFromField(fieldHtml.expense_type, 'expense_type[]', 'expense_type'));
                $row.find('.col-pattern').append(makeSelectFromField(fieldHtml.pattern, 'pattern[]', 'pattern'));
                $row.find('.col-tyre-type').append(makeSelectFromField(fieldHtml.tyre_type, 'type[]', 'type'));
                $row.find('.col-driver').append(makeSelectFromField(fieldHtml.driver, 'driver[]', 'driver'));
                $row.find('.col-vendor').append(makeSelectFromField(fieldHtml.vendor, 'vendor[]', 'vendor'));

                // Init select2 for selects inside this row
                $row.find('.sele').select2();

                // Default hide type-specific columns depending on expense type
                function toggleRow($r) {
                    const t = $r.find('select.expense_type').val();
                    const isTyre = (t === 'tyre');
                    const isMech = (t === 'mechanic');

                    // tyre inputs
                    $r.find('.tyre_no, .company').closest('td').toggle(isTyre);
                    $r.find('select.pattern, select.type, select.driver').closest('td').toggle(isTyre);

                    // mechanic inputs
                    $r.find('.mechanic_name, .spare_part_name, .labour_cost, .cost, .work_description').closest('td').toggle(isMech);

                    // for other: hide both tyre and mechanic specifics
                    if (!isTyre && !isMech) {
                        $r.find('.tyre_no, .company').closest('td').hide();
                        $r.find('select.pattern, select.type, select.driver').closest('td').hide();
                        $r.find('.mechanic_name, .spare_part_name, .labour_cost, .cost, .work_description').closest('td').hide();
                    }
                }

                $row.on('change', 'select.expense_type', function () {
                    toggleRow($row);
                });

                // Mechanic auto-calc: labour + cost -> amount
                $row.on('input', '.labour_cost, .cost', function () {
                    const t = $row.find('select.expense_type').val();
                    if (t === 'mechanic') {
                        const labour = parseFloat($row.find('.labour_cost').val()) || 0;
                        const cost = parseFloat($row.find('.cost').val()) || 0;
                        const total = labour + cost;
                        $row.find('.amount').val(total.toFixed(2));
                        updateGrandTotal();
                    }
                });

                $row.on('input', '.amount', function () {
                    updateGrandTotal();
                });

                toggleRow($row);
            }

            function addRow() {
                const $row = $(buildRowHtml());
                $('#expense-rows-body').append($row);
                applyRowControls($row);
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let total = 0;
                $('#expense-rows-body .amount').each(function () {
                    const v = parseFloat($(this).val());
                    if (!isNaN(v)) total += v;
                });
                $('#grand_total').val(total.toFixed(2));
            }

            $(document).ready(function() {
                // Start with 1 row
                addRow();

                $('#add-expense-row').on('click', function () {
                    addRow();
                });

                $('#expense-rows-body').on('click', '.remove-row', function () {
                    $(this).closest('tr').remove();
                    updateGrandTotal();
                });
            });

            // Prevent duplicate submissions
            $('#payment-button').on('click', function(e) {
                var submitButton = $(this);
                if (submitButton.prop('disabled')) {
                    e.preventDefault();
                    return false;
                }
                // Disable button after a small delay to allow form submission to proceed
                setTimeout(function() {
                    submitButton.prop('disabled', true);
                    $('#payment-button-amount').text('Submitting...');
                }, 10);
            });
        </script>

    {% endblock js %}
